<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Register | TOPCIT Quest</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/coin.png">
  <script src="https://accounts.google.com/gsi/client?hl=en" async defer></script>
  <script defer src="script.js"></script>
</head>
<body class="auth-bg">
  <!-- Auth page: header removed -->

  <main class="container auth-page" aria-label="Main">
    <section class="auth-shell">
      <aside class="auth-illustration">
        <!-- background handled via .auth-page.auth-bg -->
      </aside>
      <div class="auth-panel card">
        <div class="auth-brand register-brand">
          <img src="topcit-quest-logo.svg" alt="TOPCIT Quest logo" class="auth-logo" />
        </div>
        <h2 style="margin:0 0 8px">Register</h2>
        <p class="topic-desc" style="margin-bottom:16px">Fill in your details below.</p>

        <form id="register-form" novalidate>
          <div class="grid-12" style="gap:12px">
            <label class="span-6">
              <div class="topic-title" style="font-size:13px">Name</div>
              <input type="text" id="reg-name" class="text-input" placeholder="Your name" required />
            </label>
            <label class="span-6">
              <div class="topic-title" style="font-size:13px">Username</div>
              <input type="text" id="reg-username" class="text-input" placeholder="Choose a username" required />
            </label>
            <label class="span-6">
              <div class="topic-title" style="font-size:13px">Email</div>
              <input type="email" id="reg-email" class="text-input" placeholder="you@example.com" required />
            </label>
            <label class="span-6">
              <div class="topic-title" style="font-size:13px">Phone Number</div>
              <input type="tel" id="reg-phone" class="text-input" placeholder="+63 912 345 6789" />
            </label>
            <label class="span-6">
              <div class="topic-title" style="font-size:13px">Password</div>
              <div class="password-field">
                <input type="password" id="reg-password" class="text-input" placeholder="••••••••" required />
                <button type="button" class="password-toggle" onclick="togglePassword('reg-password', this)">
                  <span class="ms">visibility</span>
                </button>
              </div>
            </label>
            <label class="span-6">
              <div class="topic-title" style="font-size:13px">Confirm Password</div>
              <div class="password-field">
                <input type="password" id="reg-confirm" class="text-input" placeholder="••••••••" required />
                <button type="button" class="password-toggle" onclick="togglePassword('reg-confirm', this)">
                  <span class="ms">visibility</span>
                </button>
              </div>
            </label>
          </div>
          <div class="auth-actions">
            <button class="btn primary" type="submit">Create account</button>
            <div id="google-render-target"></div>
          </div>
          <div style="margin-top:12px;color:var(--muted);font-weight:700">
            Already have an account? <a href="login.html" class="link-text">Login</a>
          </div>
          <div id="register-error" class="topic-desc" style="color:#dc2626;display:none;margin-top:8px">Please fix the highlighted fields.</div>
        </form>
      </div>
    </section>
  </main>

  <footer class="app-footer">© 2025 Topcit Quest</footer>

  <script>
    // Google OAuth Configuration
    const GOOGLE_CLIENT_ID = '598357286838-uvrs8bi3apbvnu4bkm6d6ojtdhfq819j.apps.googleusercontent.com'; // Google Client ID for OAuth authentication
    
    function saveUser(user){
      try{ localStorage.setItem('topcit_user', JSON.stringify(user)); }catch(_){ }
    }
    function isValidEmail(v){ return /.+@.+\..+/.test(v) }
    function isValidUsername(u){ return /^[a-zA-Z0-9_.-]{3,}$/.test(u) }
    function isValidPhonePH(v){
      if(!v) return true; // optional
      return /(\+63\s?9\d{2}\s?\d{3}\s?\d{4}|09\d{2}\s?\d{3}\s?\d{4})$/.test(v.trim());
    }
    function setFieldError(el, has){ if(el) el.classList.toggle('error', !!has); }
    // Phone input helpers: enforce '+63 ' prefix and treat prefix-only as empty
    const PH_PREFIX = '+63 ';
    function normalizePhoneInput(v){
      const t = String(v||'').trim();
      if(t === '+63') return '';
      return t;
    }
    function setupPhonePrefix(){
      const input = document.getElementById('reg-phone');
      if(!input) return;
      if(!input.value){ input.value = PH_PREFIX; }
      input.addEventListener('focus', ()=>{
        const v = String(input.value||'');
        if(!v || !v.startsWith('+63')){ input.value = PH_PREFIX; }
        try{ input.setSelectionRange(input.value.length, input.value.length); }catch(_){ }
      });
      input.addEventListener('keydown', (e)=>{
        const pos = input.selectionStart||0;
        if(pos <= 4 && (e.key === 'Backspace' || e.key === 'Delete')){ e.preventDefault(); }
      });
      input.addEventListener('blur', ()=>{
        const t = normalizePhoneInput(input.value);
        if(!t){ input.value = ''; }
      });
    }
    
    // Local guard to ensure Google Identity script is loaded
    function ensureGsi(cb){
      try{
        if(window.google && google.accounts && google.accounts.id){ cb(); return; }
      }catch(_){ }
      const tag = document.querySelector('script[src*="accounts.google.com/gsi/client"]') || document.getElementById('google-gsi-client');
      if(typeof ensureGoogleClientLoaded === 'function'){ ensureGoogleClientLoaded(cb); return; }
      if(tag){ tag.addEventListener('load', ()=> cb()); } else { window.addEventListener('load', ()=> cb()); }
    }

    // Initialize Google OAuth when the page loads (after GIS is ready)
    window.onload = function() {
      ensureGsi(()=>{
        try{
          google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID,
            callback: handleGoogleResponse
          });
          const tgt = document.getElementById('google-render-target');
          if(tgt){
            const regBtn = document.querySelector('.auth-actions .btn.primary');
            const w = regBtn ? Math.round(regBtn.getBoundingClientRect().width) : 0;
            const opts = { theme: 'filled_blue', size: 'large', text: 'continue_with', shape: 'pill', logo_alignment: 'left', locale: 'en' };
            if(w > 0){ opts.width = w; }
            google.accounts.id.renderButton(tgt, opts);
          }
        }catch(_){ }
      });
    };
    
    // Handle Google OAuth response
    function handleGoogleResponse(response) {
      try {
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        const user = {
          name: payload.name,
          email: payload.email,
          picture: payload.picture,
          provider: 'google'
        };
        // Restrict to SLU domain
        const hd = payload.hd || '';
        const email = String(payload.email||'');
        const isSLU = hd === 'slu.edu.ph' || email.endsWith('@slu.edu.ph');
        if(!isSLU){
          const err = document.getElementById('register-error');
          err.textContent = 'Only SLU (@slu.edu.ph) Google accounts are allowed.';
          err.style.display = 'block';
          return;
        }
        saveUser(user);
        localStorage.setItem('topcit_notice', 'logged_in');
        showGoogleLoginSuccessModal(user.name);
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
      } catch (error) {
        console.error('Google authentication error:', error);
        document.getElementById('register-error').textContent = 'Google authentication failed. Please try again.';
        document.getElementById('register-error').style.display = 'block';
      }
    }
    
    // Old custom prompt-based Google flow removed; official button is rendered above.
    
    document.getElementById('register-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const regBtn = document.querySelector('.auth-actions .btn.primary');
      const originalBtnText = regBtn ? regBtn.textContent : 'Create account';
      function setBtnWaiting(on){
        if(!regBtn) return;
        if(on){
          regBtn.textContent = 'Please Wait..';
          regBtn.disabled = true;
          regBtn.classList.add('is-waiting');
          regBtn.style.opacity = '0.7';
          regBtn.style.pointerEvents = 'none';
        } else {
          regBtn.textContent = originalBtnText;
          regBtn.disabled = false;
          regBtn.classList.remove('is-waiting');
          regBtn.style.opacity = '';
          regBtn.style.pointerEvents = '';
        }
      }
      const nameEl = document.getElementById('reg-name');
      const userEl = document.getElementById('reg-username');
      const emailEl = document.getElementById('reg-email');
      const phoneEl = document.getElementById('reg-phone');
      const passEl = document.getElementById('reg-password');
      const confEl = document.getElementById('reg-confirm');
      const err = document.getElementById('register-error');

      const name = nameEl.value.trim();
      const username = userEl.value.trim();
      const email = emailEl.value.trim();
      const phone = normalizePhoneInput(phoneEl.value);
      const pass = passEl.value;
      const conf = confEl.value;

      const errors = [];
      [nameEl,userEl,emailEl,phoneEl,passEl,confEl].forEach(el=>setFieldError(el,false));
      err.style.display = 'none';
      err.innerHTML = '';

      if(!name){ errors.push('Full name is required.'); setFieldError(nameEl,true); }
      if(!username){ errors.push('Username is required.'); setFieldError(userEl,true); }
      else if(!isValidUsername(username)){ errors.push('Username must be 3+ characters (letters, numbers, ., _, -).'); setFieldError(userEl,true); }
      if(!email){ errors.push('Email is required.'); setFieldError(emailEl,true); }
      else if(!isValidEmail(email)){ errors.push('Enter a valid email address.'); setFieldError(emailEl,true); }
      if(phone && !isValidPhonePH(phone)){ errors.push('Phone should be PH format: +63 9XX XXX XXXX or 09XX XXX XXXX.'); setFieldError(phoneEl,true); }
      if(!pass){ errors.push('Password is required.'); setFieldError(passEl,true); }
      else if(pass.length < 6){ errors.push('Password must be at least 6 characters.'); setFieldError(passEl,true); }
      if(!conf){ errors.push('Please confirm your password.'); setFieldError(confEl,true); }
      else if(pass !== conf){ errors.push('Passwords do not match.'); setFieldError(confEl,true); }

      if(errors.length){ err.innerHTML = errors.join('<br>'); err.style.display = 'block'; return; }

      // Create account in database
      try{
        setBtnWaiting(true);
        const resp = await fetch('/api/users/register', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, username, email, password: pass })
        });
        const data = await resp.json();
        if(!resp.ok || !data.ok){
          err.textContent = data.error || 'Registration failed. Please try a different username/email.';
          err.style.display = 'block';
          setBtnWaiting(false);
          return;
        }
        // Trigger verification email after successful registration
        try{ localStorage.setItem('pending_verification_email', email); }catch(_){}
        // Show a waiting modal while we start the email verification
        const sendingModal = showVerificationSendingModal();
        try{
          const vResp = await fetch('/api/users/verify/start', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ identity: email })
          });
          const vData = await vResp.json();
          if(vResp.ok && vData.ok){
            // Keep the sending modal visible until redirect
          }else{
            try{ sendingModal.close(); }catch(_){}
            setBtnWaiting(false);
            err.textContent = 'Account created. Failed to send verification email. Please use the Verify page.';
            err.style.display = 'block';
          }
        }catch(_){
          try{ sendingModal.close(); }catch(_){}
          setBtnWaiting(false);
          err.textContent = 'Account created. Unable to start verification. Please use the Verify page.';
          err.style.display = 'block';
        }
      }catch(ex){
        err.textContent = 'Registration request failed. Please try again.';
        err.style.display = 'block';
        setBtnWaiting(false);
        return;
      }
      // Do NOT auto-login; require email verification before login
      // Offer next step to verification page
      setTimeout(()=>{ window.location.href = 'verify.html'; }, 2000);
    });
    // Initialize phone input prefix behavior
    setupPhonePrefix();
    
    // No click handler needed for Google; the rendered button manages the flow.
    
    // Password toggle functionality
    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      const icon = button.querySelector('.ms');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.textContent = 'visibility_off';
      } else {
        input.type = 'password';
        icon.textContent = 'visibility';
      }
    }
    
    // Google login success modal
    function showGoogleLoginSuccessModal(userName) {
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop google-success-modal';
      modal.innerHTML = `
        <div class="modal card" style="max-width: 400px; text-align: center;">
          <div style="margin-bottom: 16px;">
            <img src="images/complete.png" alt="Success" style="width:48px;height:48px;border-radius:8px" />
          </div>
          <h3 style="margin: 0 0 8px; color: var(--text);">Welcome, ${userName}!</h3>
          <p style="margin: 0; color: var(--muted);">Successfully registered with Google. Redirecting...</p>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Show modal with animation
      setTimeout(() => modal.classList.add('open'), 10);
      
      // Remove modal after redirect
      setTimeout(() => {
        modal.classList.remove('open');
        setTimeout(() => document.body.removeChild(modal), 300);
      }, 1800);
    }

    // Verification email sent modal
    function showVerificationSentModal(userName){
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop verify-sent-modal';
      modal.innerHTML = `
        <div class="modal card" style="max-width: 420px; text-align: center;">
          <div style="margin-bottom: 16px;">
            <span class="ms" style="font-size: 48px; color: #3b82f6;">mark_email_read</span>
          </div>
          <h3 style="margin: 0 0 8px; color: var(--text);">Almost there, ${userName}!</h3>
          <p style="margin: 0; color: var(--muted);">We sent a verification link to your email. Please verify to log in.</p>
          <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: center;">
            <a href="verify.html" class="btn primary">Go to verification</a>
            <button class="btn" data-close>Maybe later</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      setTimeout(()=> modal.classList.add('open'), 10);
      const backdrop = modal;
      function close(){ backdrop.classList.remove('open'); setTimeout(()=> document.body.removeChild(backdrop), 200); }
      backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) close(); });
      backdrop.querySelector('[data-close]')?.addEventListener('click', close);
      document.addEventListener('keydown', function handler(ev){ if(ev.key==='Escape'){ close(); document.removeEventListener('keydown', handler); } });
    }

    // Sending verification email modal (shown during redirect wait)
    function showVerificationSendingModal(){
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop sending-verification-modal';
      backdrop.innerHTML = `
        <div class="modal card" style="max-width: 420px; text-align: center;">
          <div style="margin-bottom: 16px;">
            <span class="ms" style="font-size: 48px; color: #3b82f6;">schedule_send</span>
          </div>
          <h3 style="margin: 0 0 8px; color: var(--text);">Sending verification email</h3>
          <p style="margin: 0; color: var(--muted);">Please wait... redirecting to verification.</p>
        </div>
      `;
      document.body.appendChild(backdrop);
      setTimeout(()=> backdrop.classList.add('open'), 10);
      return {
        close(){
          try{
            backdrop.classList.remove('open');
            setTimeout(()=>{ if(backdrop.parentNode) backdrop.parentNode.removeChild(backdrop); }, 200);
          }catch(_){}
        }
      };
    }
  </script>
</body>
</html>