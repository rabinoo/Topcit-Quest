<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login | TOPCIT Quest</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script defer src="script.js"></script>
</head>
<body class="auth-bg">
  <!-- Auth page: header removed -->

  <main class="container auth-page" aria-label="Main">
    <section class="auth-shell">
      <aside class="auth-illustration">
        <!-- background handled via .auth-page.auth-bg -->
      </aside>
      <div class="auth-panel card login-panel">
        <div class="auth-brand login-brand">
          <img src="topcit-quest-logo.svg" alt="TOPCIT Quest logo" class="auth-logo" />
        </div>

        <h2 style="margin:0 0 8px">Sign in</h2>
        <p class="topic-desc" style="margin-bottom:16px">Use your account to continue.</p>

        <form id="login-form" novalidate>
          <div style="display:grid;gap:12px">
            <label>
              <div class="topic-title" style="font-size:13px">Username or Email</div>
              <input type="text" id="login-username" class="text-input" placeholder="Enter your username or email" required />
            </label>
            <label>
              <div class="topic-title" style="font-size:13px">Password</div>
              <div class="password-field">
                <input type="password" id="login-password" class="text-input" placeholder="••••••••" required />
                <button type="button" class="password-toggle" onclick="togglePassword('login-password', this)">
                  <span class="ms">visibility</span>
                </button>
              </div>
            </label>
          </div>
          <div class="auth-actions">
            <button class="btn primary" type="submit">Login</button>
            <button class="btn google-btn" type="button" id="google-login"><span class="google-icon-badge"><img src="images/google.webp" alt="Google" class="google-icon"></span><span class="google-text">Continue with Google</span></button>
          </div>
          <div style="margin-top:12px;color:var(--muted);font-weight:700">
            Don't have an account? <a href="register.html" class="link-text">Register</a>
          </div>
          <div id="login-error" class="topic-desc" style="color:#dc2626;display:none;margin-top:8px">Invalid credentials. Try again.</div>
        </form>
      </div>
    </section>
  </main>

  <footer class="app-footer">© 2025 Topcit Quest</footer>

  <script>
    // Google OAuth Configuration
    const GOOGLE_CLIENT_ID = '598357286838-uvrs8bi3apbvnu4bkm6d6ojtdhfq819j.apps.googleusercontent.com'; // Google Client ID for OAuth authentication
    
    function saveUser(user){
      try{ localStorage.setItem('topcit_user', JSON.stringify(user)); }catch(_){}
    }
    function isValid(str){ return typeof str === 'string' && str.trim().length > 0 }
    function isValidEmail(v){ return /.+@.+\..+/.test(v) }
    function setFieldError(el, has){ if(el) el.classList.toggle('error', !!has); }
    
    // Initialize Google OAuth when the page loads
    window.onload = function() {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleGoogleResponse
      });
    };
    
    // Handle Google OAuth response
    function handleGoogleResponse(response) {
      try {
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        const user = {
          name: payload.name,
          email: payload.email,
          picture: payload.picture,
          provider: 'google'
        };
        saveUser(user);
        localStorage.setItem('topcit_notice', 'logged_in');
        showGoogleLoginSuccessModal(user.name);
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
      } catch (error) {
        console.error('Google authentication error:', error);
        document.getElementById('login-error').textContent = 'Google authentication failed. Please try again.';
        document.getElementById('login-error').style.display = 'block';
      }
    }
    
    // Trigger Google OAuth when button is clicked
    function initiateGoogleLogin() {
      google.accounts.id.prompt();
    }
    
    document.getElementById('login-form').addEventListener('submit', function(e){
      e.preventDefault();
      const uEl = document.getElementById('login-username');
      const pEl = document.getElementById('login-password');
      const u = uEl.value.trim();
      const p = pEl.value;
      const err = document.getElementById('login-error');
      err.style.display = 'none';
      err.innerHTML = '';
      setFieldError(uEl,false); setFieldError(pEl,false);

      const errors = [];
      if(!isValid(u)){ errors.push('Enter your username or email.'); setFieldError(uEl,true); }
      else if(u.includes('@') && !isValidEmail(u)){ errors.push('Enter a valid email address.'); setFieldError(uEl,true); }
      if(!isValid(p)){ errors.push('Password is required.'); setFieldError(pEl,true); }
      else if(p.length < 6){ errors.push('Password must be at least 6 characters.'); setFieldError(pEl,true); }

      if(errors.length){ err.innerHTML = errors.join('<br>'); err.style.display = 'block'; return; }

      // Preserve full name if previously registered, allow login via username or email
      let existing = null;
      try{ const raw = localStorage.getItem('topcit_user'); existing = raw ? JSON.parse(raw) : null; }catch(_){ existing = null; }
      const isEmail = u.includes('@');
      const next = Object.assign({}, existing || {});
      next.provider = 'local';
      if(isEmail){ next.email = u; } else { next.username = u; }
      if(!next.name){ next.name = isEmail ? (existing?.name || u) : (existing?.name || next.username || u); }
      saveUser(next);
      try{ localStorage.setItem('topcit_notice','logged_in'); }catch(_){}
      window.location.href = 'index.html';
    });
    
    document.getElementById('google-login').addEventListener('click', initiateGoogleLogin);
    
    // Password toggle functionality
    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      const icon = button.querySelector('.ms');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.textContent = 'visibility_off';
      } else {
        input.type = 'password';
        icon.textContent = 'visibility';
      }
    }
    
    // Google login success modal
    function showGoogleLoginSuccessModal(userName) {
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop google-success-modal';
      modal.innerHTML = `
        <div class="modal card" style="max-width: 400px; text-align: center;">
          <div style="margin-bottom: 16px;">
            <span class="ms" style="font-size: 48px; color: #10b981;">check_circle</span>
          </div>
          <h3 style="margin: 0 0 8px; color: var(--text);">Welcome back, ${userName}!</h3>
          <p style="margin: 0; color: var(--muted);">Successfully logged in with Google. Redirecting...</p>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Show modal with animation
      setTimeout(() => modal.classList.add('open'), 10);
      
      // Remove modal after redirect
      setTimeout(() => {
        modal.classList.remove('open');
        setTimeout(() => document.body.removeChild(modal), 300);
      }, 1800);
    }
  </script>
</body>
</html>