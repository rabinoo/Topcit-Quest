<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login | TOPCIT Quest</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
  <link rel="icon" type="image/png" href="images/coin.png">
  <script src="https://accounts.google.com/gsi/client?hl=en" async defer></script>
  <script defer src="script.js"></script>
</head>
<body class="auth-bg">
  <!-- Auth page: header removed -->

  <main class="container auth-page" aria-label="Main">
    <section class="auth-shell">
      <aside class="auth-illustration">
        <!-- background handled via .auth-page.auth-bg -->
      </aside>
      <div class="auth-panel card login-panel">
        <div class="auth-brand login-brand">
          <img src="topcit-quest-logo.svg" alt="TOPCIT Quest logo" class="auth-logo" />
        </div>

        <h2 style="margin:0 0 8px">Sign in</h2>
        <p class="topic-desc" style="margin-bottom:16px">Use your account to continue.</p>

        <form id="login-form" novalidate>
          <div style="display:grid;gap:12px">
            <label>
              <div class="topic-title" style="font-size:13px">Username or Email</div>
              <input type="text" id="login-username" class="text-input" placeholder="Enter your username or email" required />
            </label>
            <label>
              <div class="topic-title" style="font-size:13px">Password</div>
              <div class="password-field">
                <input type="password" id="login-password" class="text-input" placeholder="••••••••" required />
                <button type="button" class="password-toggle" onclick="togglePassword('login-password', this)">
                  <span class="ms">visibility</span>
                </button>
              </div>
            </label>
          </div>
          <div class="auth-actions">
            <button class="btn primary" type="submit">Login</button>
            <div id="google-render-target"></div>
          </div>
          <div style="margin-top:12px;color:var(--muted);font-weight:700">
            Don't have an account? <a href="register.html" class="link-text">Register</a>
          </div>
          <div style="margin-top:6px;color:var(--muted);font-weight:700">
            Need help? <a href="reset.html" class="link-text">Reset password</a>
          </div>
          <div id="login-error" class="topic-desc" style="color:#dc2626;display:none;margin-top:8px">Invalid credentials. Try again.</div>
          <div id="login-hint" class="topic-desc" style="display:none;margin-top:8px;color:#b45309"></div>
        </form>
      </div>
    </section>
  </main>

  <footer class="app-footer">© 2025 Topcit Quest</footer>

  <script>
    // Google OAuth Configuration
    const GOOGLE_CLIENT_ID = '598357286838-uvrs8bi3apbvnu4bkm6d6ojtdhfq819j.apps.googleusercontent.com'; // Google Client ID for OAuth authentication
    
    function saveUser(user){
      try{ localStorage.setItem('topcit_user', JSON.stringify(user)); }catch(_){}
    }
    function isValid(str){ return typeof str === 'string' && str.trim().length > 0 }
    function isValidEmail(v){ return /.+@.+\..+/.test(v) }
    function setFieldError(el, has){ if(el) el.classList.toggle('error', !!has); }
    
    // Local guard to ensure Google Identity script is loaded
    function ensureGsi(cb){
      try{
        if(window.google && google.accounts && google.accounts.id){ cb(); return; }
      }catch(_){ }
      const tag = document.querySelector('script[src*="accounts.google.com/gsi/client"]') || document.getElementById('google-gsi-client');
      if(typeof ensureGoogleClientLoaded === 'function'){ ensureGoogleClientLoaded(cb); return; }
      if(tag){ tag.addEventListener('load', ()=> cb()); } else { window.addEventListener('load', ()=> cb()); }
    }

    // Initialize Google OAuth when the page loads (after GIS is ready)
    window.onload = function() {
      ensureGsi(()=>{
        try{
          google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID,
            callback: handleGoogleResponse
          });
          const tgt = document.getElementById('google-render-target');
          if(tgt){
            const loginBtn = document.querySelector('.auth-actions .btn.primary');
            const w = loginBtn ? Math.round(loginBtn.getBoundingClientRect().width) : 0;
            const opts = { theme: 'filled_blue', size: 'large', text: 'continue_with', shape: 'pill', logo_alignment: 'left', locale: 'en' };
            if(w > 0){ opts.width = w; }
            google.accounts.id.renderButton(tgt, opts);
          }
        }catch(_){ }
      });
    };
    
    // Handle Google OAuth response
    function handleGoogleResponse(response) {
      try {
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        const user = {
          name: payload.name,
          email: payload.email,
          picture: payload.picture,
          provider: 'google'
        };
        // Restrict to SLU domain
        const hd = payload.hd || '';
        const email = String(payload.email||'');
        const isSLU = hd === 'slu.edu.ph' || email.endsWith('@slu.edu.ph');
        if(!isSLU){
          const err = document.getElementById('login-error');
          err.textContent = 'Only SLU (@slu.edu.ph) Google accounts are allowed.';
          err.style.display = 'block';
          return;
        }
        saveUser(user);
        localStorage.setItem('topcit_notice', 'logged_in');
        showGoogleLoginSuccessModal(user.name);
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
      } catch (error) {
        console.error('Google authentication error:', error);
        document.getElementById('login-error').textContent = 'Google authentication failed. Please try again.';
        document.getElementById('login-error').style.display = 'block';
      }
    }
    
    // Removed custom click-to-prompt flow; the official Google button is rendered above.
    
    document.getElementById('login-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const uEl = document.getElementById('login-username');
      const pEl = document.getElementById('login-password');
      const identity = uEl.value.trim();
      const password = pEl.value;
      const err = document.getElementById('login-error');
      err.style.display = 'none';
      err.innerHTML = '';
      setFieldError(uEl,false); setFieldError(pEl,false);

      const errors = [];
      if(!isValid(identity)){ errors.push('Enter your username or email.'); setFieldError(uEl,true); }
      else if(identity.includes('@') && !isValidEmail(identity)){ errors.push('Enter a valid email address.'); setFieldError(uEl,true); }
      if(!isValid(password)){ errors.push('Password is required.'); setFieldError(pEl,true); }
      else if(password.length < 6){ errors.push('Password must be at least 6 characters.'); setFieldError(pEl,true); }

      if(errors.length){ err.innerHTML = errors.join('<br>'); err.style.display = 'block'; return; }

      try{
        const resp = await fetch('/api/users/login', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identity, password })
        });
        const data = await resp.json();
        // Unverified email gating from server
        if(resp.status === 403 && data && data.needs_verification){
          err.style.display = 'none';
          const hint = document.getElementById('login-hint');
          if(hint){
            hint.innerHTML = 'Your email is not verified. Please check your inbox for the verification link, or <button class="btn" id="resend-verify-btn" style="padding:4px 10px">Resend email</button>.';
            hint.style.display = 'block';
            const btn = document.getElementById('resend-verify-btn');
            btn?.addEventListener('click', async ()=>{
              try{
                const vResp = await fetch('/api/users/verify/start', {
                  method: 'POST', headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ identity })
                });
                const vData = await vResp.json();
                if(vResp.ok && vData.ok){
                  hint.innerHTML = 'Verification email resent. Please check your inbox.';
                }else{
                  hint.innerHTML = 'Unable to resend email. Please use the <a class="link-text" href="verify.html">verification page</a>.';
                }
              }catch(_){ hint.innerHTML = 'Request failed. Please use the <a class="link-text" href="verify.html">verification page</a>.'; }
            });
          }
          try { showVerificationNudgeModal(identity); } catch(_){ }
          return;
        }
        if(!resp.ok || !data.ok){
          err.textContent = data.error || 'Invalid credentials. Try again.';
          err.style.display = 'block';
          return;
        }
        // Store DB-backed user
        const user = Object.assign({ provider: 'db' }, data.user || {});
        if(data.token){ user.token = data.token; }
        saveUser(user);
        try{ localStorage.setItem('topcit_notice','logged_in'); }catch(_){}
        const hint = document.getElementById('login-hint');
        if(user && user.email_verified === false){
          if(hint){
            hint.innerHTML = 'Your email is not verified. Some features may be limited. Please <a class="link-text" href="verify.html">verify your email</a>.';
            hint.style.display = 'block';
          }
          // Prominent nudge modal to encourage verification
          try { showVerificationNudgeModal(user.name || identity); } catch(_){ }
          return; // keep user on login page to encourage verification
        }
        try{ showLoginSuccessModal(user.name || identity); }catch(_){ }
        setTimeout(()=>{ window.location.href = 'index.html'; }, 1500);
      }catch(ex){
        err.textContent = 'Login request failed. Please try again.';
        err.style.display = 'block';
      }
    });
    
    // Custom Google button removed; no click handler needed.
    
    // Password toggle functionality
    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      const icon = button.querySelector('.ms');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.textContent = 'visibility_off';
      } else {
        input.type = 'password';
        icon.textContent = 'visibility';
      }
    }
    
    // Google login success modal
    function showGoogleLoginSuccessModal(userName) {
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop google-success-modal';
      modal.innerHTML = `
        <div class="modal card" style="max-width: 400px; text-align: center;">
          <div style="margin-bottom: 16px;">
            <img src="images/complete.png" alt="Success" style="width:48px;height:48px;border-radius:8px" />
          </div>
          <h3 style="margin: 0 0 8px; color: var(--text);">Welcome back, ${userName}!</h3>
          <p style="margin: 0; color: var(--muted);">Successfully logged in with Google. Redirecting...</p>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Show modal with animation
      setTimeout(() => modal.classList.add('open'), 10);
      
      // Remove modal after redirect
      setTimeout(() => {
        modal.classList.remove('open');
        setTimeout(() => document.body.removeChild(modal), 300);
      }, 1800);
    }
    
    // Verification nudge modal
    function showVerificationNudgeModal(userName){
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop verify-nudge-modal';
      modal.innerHTML = `
        <div class="modal card" style="max-width: 460px; text-align: center;">
          <div style="margin-bottom: 16px;">
            <span class="ms" style="font-size: 48px; color: #b45309;">warning</span>
          </div>
          <h3 style="margin: 0 0 8px; color: var(--text);">Verify your email${userName?`, ${userName}`:''}</h3>
          <p style="margin: 0 0 12px; color: var(--muted);">To fully access features and admin tools, please verify your email.</p>
          <div style="display:flex; gap:8px; justify-content:center;">
            <a class="btn primary" href="verify.html">Go to verification</a>
            <button class="btn" id="close-verify-nudge">Maybe later</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      setTimeout(()=> modal.classList.add('open'), 10);
      const close = ()=>{
        modal.classList.remove('open');
        setTimeout(()=>{ try{ document.body.removeChild(modal); }catch(_){ } }, 300);
      };
      modal.addEventListener('click', (e)=>{ if(e.target === modal) close(); });
      const btn = modal.querySelector('#close-verify-nudge');
      if(btn) btn.addEventListener('click', close);
    }

    // Login success modal (DB login)
    function showLoginSuccessModal(userName){
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop login-success-modal';
      modal.innerHTML = `
        <div class="modal card" style="max-width: 420px; text-align: center;">
          <div style="margin-bottom: 16px;">
            <img src="images/complete.png" alt="Success" style="width:48px;height:48px;border-radius:8px" />
          </div>
          <h3 style="margin: 0 0 8px; color: var(--text);">Login successful</h3>
          <p style="margin: 0; color: var(--muted);">Redirecting to dashboard…</p>
        </div>
      `;
      document.body.appendChild(modal);
      setTimeout(()=> modal.classList.add('open'), 10);
      setTimeout(()=>{
        modal.classList.remove('open');
        setTimeout(()=>{ try{ document.body.removeChild(modal); }catch(_){ } }, 250);
      }, 1400);
    }
  </script>
</body>
</html>