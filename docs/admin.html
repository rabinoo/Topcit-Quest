<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TOPCIT Quest ‚Ä¢ Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <script defer src="script.js"></script>
  <style>
    /* Minor admin-specific layout touches, consistent with existing palette */
    .admin-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    .builder-form label { display: block; margin-bottom: 8px; }
    .builder-form .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .thumb-picks { display: grid; grid-template-columns: repeat(4, 72px); gap: 8px; margin-top: 8px; }
    .thumb-picks img { width: 72px; height: 72px; border-radius: 8px; object-fit: cover; cursor: pointer; border: 2px solid var(--muted); }
    .thumb-picks img.selected { border-color: var(--accent); }
    .module-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; margin-top: 12px; }
    .module-card h4 { margin: 8px 0 4px; }
    .muted-note { color: var(--muted); font-size: 13px; }
    /* Module card spacing improvements */
    .module-card .meta { display:flex; align-items:center; gap:8px; margin:8px 0 10px; }
    .module-card .course-actions { display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .module-card .thumb-wrap{ margin-bottom:6px; }
  </style>
  </head>
<body>
  <header class="app-header">
    <div class="header-top">
      <div class="brand">
        <div class="logo"><img class="logo-img" src="topcit-quest-logo.svg" alt="TOPCIT Quest logo"></div>
        <div class="titles">
          <h1>TOPCIT Quest</h1>
          <p class="subtitle">Admin Tools</p>
        </div>
      </div>
      <nav class="main-nav" aria-label="Primary">
        <a class="tab" href="index.html" title="Dashboard"><img class="tab-icon" src="images/dashboard.png" alt="Dashboard icon"> <span>Dashboard</span></a>
        <a class="tab" href="learn.html" title="Learn"><img class="tab-icon" src="images/Learn.png" alt="Learn icon"> <span>Learn</span></a>
        <a class="tab" href="leaderboards.html" title="Leaderboards"><img class="tab-icon" src="images/Leaderboard.png" alt="Leaderboards icon"> <span>Leaderboards</span></a>
        <a class="tab" href="rewards.html" title="Rewards"><img class="tab-icon" src="images/Rewards.png" alt="Rewards icon"> <span>Rewards</span></a>
      </nav>
      <nav class="header-controls" aria-label="User controls">
        <div class="streak-mini chip" title="Your current streak"><img class="streak-icon" src="images/streak.png" alt="Streak"><span class="streak-num">7</span><span>day streak</span></div>
        <button class="icon-btn" id="notify-btn" aria-label="Notifications"><img class="notify-icon" src="images/notification.png" alt="Notifications"><span class="dot-badge" aria-hidden="true"></span></button>
        <div class="wallet chip" title="Your coins"><img class="coin-icon" src="images/coin.png" alt="Coins"><span class="amount" data-wallet-amount>1,260</span></div>
        <div class="user-menu">
          <button class="avatar-btn" id="user-menu-btn" aria-haspopup="true" aria-expanded="false" title="Open profile & settings">
            <span class="avatar">üë©‚Äçüíª</span>
          </button>
          <div class="menu" id="user-dropdown" role="menu" aria-hidden="true">
            <button class="menu-item" role="menuitem">Profile</button>
            <button class="menu-item" role="menuitem">Settings</button>
            <button class="menu-item danger" role="menuitem" id="logout-btn">Log out</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="container" id="admin-page">
    <section class="card" id="admin-login" aria-hidden="false">
      <div class="card-head">
        <h3>Admin Login</h3>
        <span class="chip subtle">Default: User: Admin ‚Ä¢ Pass: 000000</span>
      </div>
      <form class="builder-form" style="max-width:520px">
        <label>
          <div class="topic-title">Username</div>
          <input type="text" id="admin-username" class="text-input" placeholder="Admin" />
        </label>
        <label>
          <div class="topic-title">Password</div>
          <div class="password-field">
            <input type="password" id="admin-password" class="text-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            <button type="button" class="password-toggle" id="login-toggle"><span class="ms">visibility</span></button>
          </div>
        </label>
        <div class="auth-actions" style="margin-top:8px">
          <button class="btn primary" type="button" id="admin-login-btn">Login</button>
        </div>
        <div id="admin-login-error" class="topic-desc" style="color:#dc2626;display:none;margin-top:8px">Invalid credentials. Try again.</div>
      </form>
    </section>

    <section class="card" id="admin-builder" aria-hidden="true" style="display:none">
      <div class="card-head">
        <h3>Create Course Modules</h3>
        <span class="chip subtle">Build customized modules for the Learn page</span>
      </div>
      <div class="admin-grid">
        <form class="builder-form" id="module-form">
          <label>
            <div class="topic-title">Title</div>
            <input type="text" id="mod-title" class="text-input" placeholder="e.g., Intro to Python" required />
          </label>
          <label>
            <div class="topic-title">ID (slug)</div>
            <input type="text" id="mod-id" class="text-input" placeholder="auto-generated from title" />
            <div class="muted-note">Used as `data-course-id`.</div>
          </label>
          <label>
            <div class="topic-title">Description</div>
            <textarea id="mod-desc" class="text-input" rows="3" placeholder="Short summary..." required></textarea>
          </label>
          <label>
            <div class="topic-title">Difficulty</div>
            <select id="mod-difficulty" class="text-input">
              <option value="Beginner">Beginner</option>
              <option value="Intermediate">Intermediate</option>
              <option value="Advanced">Advanced</option>
              <option value="Expert">Expert</option>
              <option value="Impossible">Impossible</option>
            </select>
          </label>
          <div class="row">
            <label>
              <div class="topic-title">XP</div>
              <input type="number" id="mod-xp" class="text-input" placeholder="60" min="0" required />
            </label>
            <label>
              <div class="topic-title">Coins</div>
              <input type="number" id="mod-coins" class="text-input" placeholder="100" min="0" required />
            </label>
          </div>
          <label>
            <div class="topic-title">Upload Image</div>
            <input type="file" id="mod-image-file" class="text-input" accept="image/*" required />
          </label>
          <div class="muted-note">On local server, images save to <code>uploads/</code>. On static hosts (e.g., GitHub Pages), images are embedded inline.</div>
          <div class="auth-actions" style="margin-top:8px; gap:8px; display:flex; flex-wrap:wrap">
            <button class="btn primary" type="submit">Add Module</button>
          </div>
          <div class="muted-note">Content saves auto‚Äëpublish to Learn. You can also publish from each module card.</div>
        </form>

        <div>
          <h4 style="margin:0 0 8px">Your Modules</h4>
          <div class="module-list" id="modules-list"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <div>¬© 2025 TOPCIT Quest ‚Ä¢ Admin</div>
  </footer>

  <script>
    // Simple admin gate using localStorage
    const ADMIN_SESSION_KEY = 'topcit_admin_session';
    const ADMIN_DEFAULT_USER = 'Admin';
    const ADMIN_DEFAULT_PASS = '000000';
    const STORAGE_KEY = 'topcit_admin_modules';
    const PUBLISH_KEY = 'topcit_custom_modules';

    function isAdmin(){ try { return localStorage.getItem(ADMIN_SESSION_KEY) === '1'; } catch(_) { return false; } }
    function tryLogin(u,p){ if(u === ADMIN_DEFAULT_USER && p === ADMIN_DEFAULT_PASS){ localStorage.setItem(ADMIN_SESSION_KEY, '1'); return true; } return false; }
    function readModules(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }catch(_){ return []; } }
    function saveModules(mods){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(mods)); }catch(_){} }
    function publishModules(){ try{ localStorage.setItem(PUBLISH_KEY, JSON.stringify(readModules())); }catch(_){} }

    function slugify(str){ return (str||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }

    function renderModules(){
      const list = document.getElementById('modules-list');
      const mods = readModules();
      list.innerHTML = '';
      if(mods.length === 0){
        const p = document.createElement('p');
        p.className = 'muted';
        p.textContent = 'No modules yet.';
        list.appendChild(p);
        return;
      }
      // Map difficulty label to CSS chip class used across the site
      const diffClassFor = (label)=>{
        const k = String(label||'').toLowerCase();
        if(k.includes('impossible')) return 'diff-impossible';
        if(k.includes('expert')) return 'diff-expert';
        if(k.includes('advanced')) return 'diff-advanced';
        if(k.includes('intermediate')) return 'diff-intermediate';
        return 'diff-beginner';
      };
      mods.forEach((m, idx)=>{
        const card = document.createElement('article');
        card.className = 'card module-card';
        const c = m.content || {};
        const quiz = c.quiz || {};
        const bullets = Array.isArray(c.bullets) ? c.bullets.join('\n') : '';
        const refl = c.reflection || '';
        const ctf = c.ctf || {};
        const code = c.codeFill || {};
        const diffCls = diffClassFor(m.difficulty||'Beginner');
        card.innerHTML = `
          <div class="thumb-wrap"><img class="learn-thumb" src="${m.image||'images/topics/programming.svg'}" alt="${m.title} thumbnail"></div>
          <h4>${m.title}</h4>
          <p>${m.description||''}</p>
          <div class="meta"><span class="chip ${diffCls}" data-difficulty>${m.difficulty||'Beginner'}</span><span class="chip blue">XP ${m.xp||0}</span><span class="chip orange">Coins ${m.coins||0}</span></div>
          <div class="course-actions">
            <button class="btn" data-delete="${idx}">Delete</button>
            <button class="btn" data-publish="${idx}">Publish to Learn</button>
            <button class="btn primary" data-edit="${idx}">Edit Content</button>
          </div>
        `;
        list.appendChild(card);
      });
      // Bind delete buttons
      list.querySelectorAll('[data-delete]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const idx = parseInt(btn.getAttribute('data-delete'),10);
          const mods = readModules();
          mods.splice(idx,1);
          saveModules(mods);
          renderModules();
        });
      });
      // Bind per-module Publish
      list.querySelectorAll('[data-publish]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          publishModules();
          const chip = document.createElement('span');
          chip.className = 'chip green';
          chip.textContent = 'Published! Check Learn page.';
          btn.parentElement?.appendChild(chip);
          setTimeout(()=> chip.remove(), 3000);
        });
      });
      // Bind modal editor open
      list.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const idx = parseInt(btn.getAttribute('data-edit'),10);
          openContentEditor(idx);
        });
      });
    }

    function showBuilder(){
      const login = document.getElementById('admin-login');
      const builder = document.getElementById('admin-builder');
      login.style.display = 'none';
      login.setAttribute('aria-hidden','true');
      builder.style.display = '';
      builder.setAttribute('aria-hidden','false');
    }
    function showLogin(){
      const login = document.getElementById('admin-login');
      const builder = document.getElementById('admin-builder');
      builder.style.display = 'none';
      builder.setAttribute('aria-hidden','true');
      login.style.display = '';
      login.setAttribute('aria-hidden','false');
    }

    window.addEventListener('load', ()=>{
      // Gate
      if(isAdmin()) showBuilder(); else showLogin();

      // Login handling
      const loginBtn = document.getElementById('admin-login-btn');
      const uEl = document.getElementById('admin-username');
      const pEl = document.getElementById('admin-password');
      const errEl = document.getElementById('admin-login-error');
      const toggle = document.getElementById('login-toggle');
      if(toggle){ toggle.addEventListener('click', ()=>{ pEl.type = pEl.type === 'password' ? 'text' : 'password'; }); }
      if(loginBtn){
        loginBtn.addEventListener('click', ()=>{
          const u = (uEl.value||'').trim();
          const p = (pEl.value||'').trim();
          if(tryLogin(u||ADMIN_DEFAULT_USER, p)){
            errEl.style.display = 'none';
            showBuilder();
          } else {
            errEl.style.display = 'block';
          }
        });
      }

      // Builder form
      const form = document.getElementById('module-form');
      const tEl = document.getElementById('mod-title');
      const idEl = document.getElementById('mod-id');
      const dEl = document.getElementById('mod-desc');
      const xpEl = document.getElementById('mod-xp');
      const cEl = document.getElementById('mod-coins');
      const imgFileEl = document.getElementById('mod-image-file');

      const THUMB_W = 640; // standard width for course thumbnails
      const THUMB_H = 360; // standard height (16:9)

      function resizeImageToStandard(file){
        return new Promise((resolve, reject)=>{
          const img = new Image();
          img.onload = ()=>{
            const canvas = document.createElement('canvas');
            canvas.width = THUMB_W; canvas.height = THUMB_H;
            const ctx = canvas.getContext('2d');
            const srcW = img.naturalWidth || img.width;
            const srcH = img.naturalHeight || img.height;
            const scale = Math.max(THUMB_W/srcW, THUMB_H/srcH);
            const drawW = srcW * scale;
            const drawH = srcH * scale;
            const dx = (THUMB_W - drawW)/2;
            const dy = (THUMB_H - drawH)/2;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, dx, dy, drawW, drawH);
            canvas.toBlob((blob)=>{
              if(blob) resolve(blob); else reject(new Error('toBlob failed'));
            }, 'image/webp', 0.9);
          };
          img.onerror = ()=> reject(new Error('Image load failed'));
          img.src = URL.createObjectURL(file);
        });
      }

      async function uploadImage(file, suggestedName){
        const resized = await resizeImageToStandard(file);
        const fd = new FormData();
        const base = (suggestedName||'image').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
        const now = Date.now();
        fd.append('file', resized, `${base}-${now}.webp`);
        // Detect static hosting (GitHub Pages) and gracefully fallback to Data URL
        const isStaticHost = /github\.io$/i.test(location.hostname) || /githubpages/i.test(location.hostname);
        if(!isStaticHost){
          try{
            const res = await fetch('/upload', { method: 'POST', body: fd });
            if(res.ok){ const data = await res.json(); return data.path || data.url || ''; }
          }catch(_){ /* ignore and fallback */ }
        }
        // Fallback: embed image as Data URL (works on static hosts)
        const dataUrl = await new Promise((resolve, reject)=>{
          try{
            const fr = new FileReader();
            fr.onload = ()=> resolve(String(fr.result||''));
            fr.onerror = ()=> reject(new Error('DataURL failed'));
            fr.readAsDataURL(resized);
          }catch(err){ reject(err); }
        });
        return dataUrl;
      }

      // Auto-slug from title
      tEl.addEventListener('input', ()=>{ if(!idEl.value){ idEl.value = slugify(tEl.value); } });

      // Image quick picks
      // Removed quick-pick thumbnails; upload is required.

      if(form){
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const title = (tEl.value||'').trim();
          const id = slugify((idEl.value||title));
          const description = (dEl.value||'').trim();
          const difficultyEl = document.getElementById('mod-difficulty');
          const difficulty = (difficultyEl && difficultyEl.value) ? difficultyEl.value : 'Beginner';
          const xp = parseInt(xpEl.value||'0',10)||0;
          const coins = parseInt(cEl.value||'0',10)||0;
          const file = imgFileEl && imgFileEl.files ? imgFileEl.files[0] : null;
          if(!file){
            alert('Please upload an image for the module.');
            return;
          }
          let image = '';
          try { image = await uploadImage(file, id || title || 'course'); } catch(_){ alert('Upload failed. Try again.'); return; }
          if(!title || !description){ return; }
          const mods = readModules();
          mods.push({ id, title, description, xp, coins, image, difficulty });
          saveModules(mods);
          tEl.value = ''; idEl.value = ''; dEl.value = ''; xpEl.value=''; cEl.value='';
          if(imgFileEl) imgFileEl.value = '';
          if(difficultyEl) difficultyEl.value = 'Beginner';
          renderModules();
        });
      }

      // global publish removed in favor of per-card publish

      renderModules();
    });
  </script>
  <script>
    // Full-page editor for module content (replaces modal)
    function openContentEditor(idx){
      const mods = readModules();
      const m = mods[idx]; if(!m) return;
      const c = m.content || {};
      const quiz = c.quiz || {}; const options = quiz.options || [];
      const bullets = Array.isArray(c.bullets) ? c.bullets.join('\n') : '';
      const phased = c.phased || null;
      const orient = phased ? 'phased' : 'default';
      const main = document.querySelector('main');
      const builder = document.getElementById('admin-builder');
      if(builder) builder.style.display = 'none';
      const page = document.createElement('section');
      page.id = 'content-editor';
      page.className = 'card';
      page.style.marginTop = '16px';
      page.innerHTML = `
        <div class="card-head" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <h3>Edit Content ‚Äî ${m.title}</h3>
          <div style="display:flex;gap:8px">
            <button class="btn" data-back>Back to Modules</button>
          </div>
        </div>
        <div class="card-body" style="display:grid;gap:12px">
          <label>
            <div class="topic-title">Course Orientation</div>
            <select class="text-input" data-e-orient>
              <option value="default" ${orient==='default'?'selected':''}>Default tasks (Read, Quiz, Reflection, etc.)</option>
              <option value="phased" ${orient==='phased'?'selected':''}>Phased: Review ‚Üí Quiz ‚Üí Answers</option>
            </select>
          </label>

          <div data-default-editor style="display:${orient==='default'?'grid':'none'};gap:10px">
            <label><div class="topic-title">Quiz question</div><input type="text" class="text-input" data-e-quiz-q value="${quiz.question||''}"></label>
            <div class="row">
              <label><div class="topic-title">Option 1</div><input type="text" class="text-input" data-e-quiz-o1 value="${options[0]||''}"></label>
              <label><div class="topic-title">Option 2</div><input type="text" class="text-input" data-e-quiz-o2 value="${options[1]||''}"></label>
            </div>
            <div class="row">
              <label><div class="topic-title">Option 3</div><input type="text" class="text-input" data-e-quiz-o3 value="${options[2]||''}"></label>
              <label><div class="topic-title">Option 4</div><input type="text" class="text-input" data-e-quiz-o4 value="${options[3]||''}"></label>
            </div>
            <label><div class="topic-title">Correct option (1-4)</div><input type="number" min="1" max="4" class="text-input" data-e-quiz-c value="${Number.isFinite(quiz.correctIndex)?(quiz.correctIndex+1):''}"></label>
            <label><div class="topic-title">Read bullets (one per line)</div><textarea class="text-input" rows="4" data-e-bullets>${bullets}</textarea></label>
            <label><div class="topic-title">Reflection prompt</div><textarea class="text-input" rows="2" data-e-refl>${c.reflection||''}</textarea></label>
            <div class="row">
              <label><div class="topic-title">CTF prompt</div><input type="text" class="text-input" data-e-ctf-p value="${(c.ctf||{}).prompt||''}"></label>
              <label><div class="topic-title">CTF flag</div><input type="text" class="text-input" data-e-ctf-f value="${(c.ctf||{}).flag||''}"></label>
            </div>
            <label><div class="topic-title">Code snippet</div><textarea class="text-input" rows="4" data-e-code-sn>${(c.codeFill||{}).snippet||''}</textarea></label>
            <label><div class="topic-title">Code answer</div><input type="text" class="text-input" data-e-code-ans value="${(c.codeFill||{}).answer||''}"></label>
          </div>

          <div data-phased-editor style="display:${orient==='phased'?'grid':'none'};gap:10px">
            <div class="muted">Phase 1: Review materials</div>
            <label><div class="topic-title">Materials (one per line)</div><textarea class="text-input" rows="4" data-p-review>${Array.isArray(phased?.review)?phased.review.join('\n'):''}</textarea></label>
            <div class="muted">Phase 2: Quiz / Exam maker</div>
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
              <div class="topic-title">Questions</div>
              <div style="display:flex;gap:8px">
                <button class="btn small" data-add-q type="button">Add question</button>
              </div>
            </div>
            <div data-p-quiz-list style="display:grid;gap:10px"></div>
            <div class="muted">Phase 3: Review of answers is generated automatically from correct answers.</div>
          </div>
        </div>
        <div class="card-actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button class="btn" data-cancel>Cancel</button>
          <button class="btn primary" data-save>Save</button>
        </div>`;
      main.appendChild(page);
      const gv = (sel)=>{ const el = page.querySelector(sel); return el ? (el instanceof HTMLInputElement || el instanceof HTMLTextAreaElement ? el.value : '') : ''; };
      const goBack = ()=>{ page.remove(); if(builder) builder.style.display = ''; renderModules(); };
      page.querySelector('[data-back]')?.addEventListener('click', goBack);
      page.querySelector('[data-cancel]')?.addEventListener('click', (e)=>{ e.preventDefault(); goBack(); });
      // Orientation toggle
      const orientSel = page.querySelector('[data-e-orient]');
      const defaultEditor = page.querySelector('[data-default-editor]');
      const phasedEditor = page.querySelector('[data-phased-editor]');
      orientSel?.addEventListener('change', ()=>{
        const val = orientSel.value;
        if(val === 'phased'){ defaultEditor.style.display = 'none'; phasedEditor.style.display = 'grid'; }
        else { defaultEditor.style.display = 'grid'; phasedEditor.style.display = 'none'; }
      });

      // Phased quiz builder state and renderer
      let pq = Array.isArray(phased?.quiz?.questions) && phased.quiz.questions.length
        ? phased.quiz.questions.map(q=>({ question:q.question||'', options:Array.isArray(q.options)?q.options.slice(0):[], correctIndex:Number.isFinite(q.correctIndex)?q.correctIndex:0, explanation:q.explanation||'' }))
        : [{ question:'', options:['',''], correctIndex:0, explanation:'' }];
      const quizList = page.querySelector('[data-p-quiz-list]');
      function renderPQ(){
        if(!quizList) return;
        quizList.innerHTML = pq.map((q,qi)=>{
          const opts = (Array.isArray(q.options)?q.options:[]).map((opt,oi)=>{
            return `<div class="row" data-pq-opt-row>
              <label style="flex:1"><div class="topic-title">Option ${oi+1}</div><input type="text" class="text-input" data-pq-opt data-qi="${qi}" data-oi="${oi}" value="${opt||''}"></label>
              <label style="width:160px"><div class="topic-title">Correct?</div><input type="radio" name="correct-${qi}" value="${oi}" ${q.correctIndex===oi?'checked':''}></label>
            </div>`;
          }).join('');
          return `<div class="task" data-pq-item data-qi="${qi}">
            <label><div class="topic-title">Question ${qi+1}</div><input type="text" class="text-input" data-pq-q data-qi="${qi}" value="${q.question||''}"></label>
            ${opts}
            <div class="row" style="justify-content:flex-end;gap:8px">
              <button class="btn small" type="button" data-add-opt data-qi="${qi}">Add option</button>
              <button class="btn small" type="button" data-remove-q data-qi="${qi}">Remove question</button>
            </div>
            <label><div class="topic-title">Explanation (optional)</div><input type="text" class="text-input" data-pq-expl data-qi="${qi}" value="${q.explanation||''}"></label>
          </div>`;
        }).join('');
        // Bind dynamic inputs
        Array.from(quizList.querySelectorAll('[data-pq-q]')).forEach(inp=>{
          inp.addEventListener('input', ()=>{ const qi = parseInt(inp.getAttribute('data-qi'),10); pq[qi].question = inp.value; });
        });
        Array.from(quizList.querySelectorAll('[data-pq-expl]')).forEach(inp=>{
          inp.addEventListener('input', ()=>{ const qi = parseInt(inp.getAttribute('data-qi'),10); pq[qi].explanation = inp.value; });
        });
        Array.from(quizList.querySelectorAll('[data-pq-opt]')).forEach(inp=>{
          inp.addEventListener('input', ()=>{ const qi = parseInt(inp.getAttribute('data-qi'),10); const oi = parseInt(inp.getAttribute('data-oi'),10); if(!Array.isArray(pq[qi].options)) pq[qi].options=[]; pq[qi].options[oi] = inp.value; });
        });
        Array.from(quizList.querySelectorAll(`input[type="radio"]`)).forEach(r=>{
          r.addEventListener('change', ()=>{ const qi = parseInt(r.name.replace('correct-',''),10); pq[qi].correctIndex = parseInt(r.value,10)||0; });
        });
        Array.from(quizList.querySelectorAll('[data-add-opt]')).forEach(btn=>{
          btn.addEventListener('click', ()=>{ const qi = parseInt(btn.getAttribute('data-qi'),10); if(!Array.isArray(pq[qi].options)) pq[qi].options=[]; pq[qi].options.push(''); renderPQ(); });
        });
        Array.from(quizList.querySelectorAll('[data-remove-q]')).forEach(btn=>{
          btn.addEventListener('click', ()=>{ const qi = parseInt(btn.getAttribute('data-qi'),10); pq.splice(qi,1); if(pq.length===0) pq.push({ question:'', options:['',''], correctIndex:0, explanation:'' }); renderPQ(); });
        });
      }
      renderPQ();
      page.querySelector('[data-add-q]')?.addEventListener('click', ()=>{ pq.push({ question:'', options:['',''], correctIndex:0, explanation:'' }); renderPQ(); });

      page.querySelector('[data-save]')?.addEventListener('click', ()=>{
        const currentOrient = (orientSel?.value||'default');
        if(currentOrient === 'phased'){
          const bulletsRaw = gv('[data-p-review]');
          const bulletsArr = bulletsRaw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
          const qs = pq.map(q=>{
            const opts = (Array.isArray(q.options)?q.options:[]).map(s=>String(s||'').trim()).filter(Boolean);
            const has = String(q.question||'').trim() && opts.length >= 2;
            return has ? { question:String(q.question).trim(), options:opts, correctIndex: Math.max(0, Math.min(q.correctIndex||0, opts.length-1)), explanation: String(q.explanation||'').trim() } : null;
          }).filter(Boolean);
          const content = { phased: { review: bulletsArr, quiz: { questions: qs } } };
          m.content = content;
        }else{
          const q = gv('[data-e-quiz-q]').trim();
          const o1 = gv('[data-e-quiz-o1]').trim();
          const o2 = gv('[data-e-quiz-o2]').trim();
          const o3 = gv('[data-e-quiz-o3]').trim();
          const o4 = gv('[data-e-quiz-o4]').trim();
          const cidxRaw = gv('[data-e-quiz-c]').trim();
          const opts = [o1,o2,o3,o4].filter(Boolean);
          const hasQuiz = q && opts.length >= 2 && cidxRaw;
          let correctIndex = null;
          if(hasQuiz){ const n = parseInt(cidxRaw,10); correctIndex = (Number.isFinite(n) ? Math.min(Math.max(n,1),opts.length) : 1) - 1; }
          const bulletsRaw = gv('[data-e-bullets]');
          const bulletsArr = bulletsRaw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
          const refl = gv('[data-e-refl]').trim();
          const ctfP = gv('[data-e-ctf-p]').trim();
          const ctfF = gv('[data-e-ctf-f]').trim();
          const codeSn = gv('[data-e-code-sn]').trim();
          const codeAns = gv('[data-e-code-ans]').trim();
          const content = {};
          if(hasQuiz){ content.quiz = { question: q, options: opts, correctIndex }; }
          if(bulletsArr.length){ content.bullets = bulletsArr; }
          if(refl){ content.reflection = refl; }
          if(ctfP || ctfF){ content.ctf = { prompt: ctfP, flag: ctfF }; }
          if(codeSn || codeAns){ content.codeFill = { snippet: codeSn, answer: codeAns }; }
          m.content = content;
        }
        saveModules(mods);
        // Auto-publish to Learn after save
        publishModules();
        // Return to list
        goBack();
      });
    }
  </script>
</body>
</html>